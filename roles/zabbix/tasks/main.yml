- name: Create a zabbix dir
  file: 
    state: directory
    path: /data/wwwroot/zabbix

- name: Copy mysql environment and zabbix docker-compose file
  template: 
    src: '{{item.src}}'
    dest: '{{item.dest}}'
  with_items:
    - {src: .env_db_mysql,dest: /data/wwwroot/zabbix/.env_db_mysql}
    - {src: .env_db_mysql_proxy,dest: /data/wwwroot/zabbix/.env_db_mysql_proxy}
    - {src: 'docker-compose-{{zabbix_version}}.yml',dest: /data/wwwroot/zabbix/docker-compose.yml}

- name: Download .env file for zabbix{{zabbix_version}}
  get_url:
    url: https://raw.githubusercontent.com/zabbix/zabbix-docker/{{zabbix_version}}/'{{item}}'
    dest: /data/wwwroot/zabbix/'{{item}}'
  with_items:
    - .env_agent
    - .env_java
    - .env_prx
    - .env_prx_mysql
    - .env_srv
    - .env_web

- name: Use docker-compose run zabbix
  shell: | 
    docker-compose up -d
    sleep 30
  args:
    chdir: /data/wwwroot/zabbix

# check service and version
- name: Copy script files to remote
  copy: src=check_dockerapp_service.sh dest=/tmp/check_dockerapp_service.sh

- name: Check dockerapp service
  shell: bash /tmp/check_dockerapp_service.sh
  register: check_dockerapp_service
  notify: check_dockerapp_service
    
- name: Check zabbix version
  shell: >
    sudo echo "zabbix version:" $(docker images |grep zabbix-server |cut -d- -f4) |sudo tee -a /data/logs/install_version.txt  
  
    
