- name: Create a zabbix dir
  file: 
    state: directory
    path: /data/wwwroot/zabbix

- name: copy .env and docker-compose file
  tempalte: 
    src: '{{item.src}}'
    dest: '/data/wwwroot/zabbix'
  with_items:
    - .env_agent
    - .env_db_mysql
    - .env_db_mysql_proxy
    - .env_java
    - .env_prx
    - .env_prx_mysql
    - .env_srv
    - .env_web
    - 'docker-compose-{{zabbix_version}}.yml'

- name: Use docker-compose run zabbix
  shell: | 
    mv docker-compose-{{zabbix_version}}.yml docker-compose.yml
    docker-compose up -d
    sleep 30
  args:
    chdir: /data/wwwroot/zabbix

# check service and version
- name: Copy script files to remote
  copy: src=check_dockerapp_service.sh dest=/tmp/check_dockerapp_service.sh

- name: Check dockerapp service
  shell: bash /tmp/check_dockerapp_service.sh
  register: check_dockerapp_service
  notify: check_dockerapp_service
    
- name: Check zabbix version
  shell: >
    sudo echo "zabbix version:" $(docker images |grep zabbix-server |cut -d- -f4) |sudo tee -a /data/logs/install_version.txt  
  
    
